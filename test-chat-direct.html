<!DOCTYPE html>
<html>
<head>
    <title>Cupido Chat Test - Critical Rules</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        .header { background: #fff; padding: 20px; border-bottom: 1px solid #e0e0e0; }
        .header h1 { font-size: 24px; color: #333; }
        .header .status { font-size: 14px; color: #666; margin-top: 5px; }
        .prompt-info { background: #f0f8ff; padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 13px; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 16px; display: flex; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message-bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; }
        .message.user .message-bubble { background: #007AFF; color: white; }
        .message.bot .message-bubble { background: white; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .input-container { background: white; border-top: 1px solid #e0e0e0; padding: 16px; }
        .input-wrapper { display: flex; gap: 10px; }
        .input-field { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 24px; outline: none; }
        .send-button { padding: 12px 24px; background: #007AFF; color: white; border: none; border-radius: 24px; cursor: pointer; font-weight: 600; }
        .send-button:disabled { background: #ccc; cursor: not-allowed; }
        .typing-indicator { padding: 8px 16px; background: #e0e0e0; border-radius: 18px; display: inline-block; margin: 8px 0; }
        .debug-panel { position: fixed; right: 10px; top: 10px; width: 300px; background: rgba(0,0,0,0.9); color: #0f0; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .debug-line { margin: 2px 0; padding: 2px; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .info { color: #44aaff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèπ Cupido Chat - Direct API Test</h1>
            <div class="status" id="status">Connecting to server...</div>
            <div class="prompt-info">
                <strong>Active Prompt:</strong> Critical Rules<br>
                <small>‚Ä¢ 2-3 short sentences (under 60 words)<br>
                ‚Ä¢ Single questions only<br>
                ‚Ä¢ Profile building focus</small>
            </div>
        </div>
        
        <div class="chat-container" id="chat-container">
            <!-- Messages will appear here -->
        </div>
        
        <div id="typing-indicator" class="typing-indicator" style="display:none;">
            Cupido is typing...
        </div>
        
        <div class="input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="message-input" 
                    class="input-field" 
                    placeholder="Type your message..." 
                    autofocus
                />
                <button id="send-button" class="send-button">Send</button>
            </div>
        </div>
    </div>
    
    <div class="debug-panel" id="debug-panel">
        <div class="debug-line success">üü¢ Debug Mode Active</div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api/chat';
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const statusEl = document.getElementById('status');
        const debugPanel = document.getElementById('debug-panel');
        
        let messages = [];
        let isSending = false;
        
        // Critical Rules System Prompt
        const CRITICAL_RULES_PROMPT = `You are Cupido, helping someone build a meaningful dating profile while discovering themselves. Balance learning their basics with exploring who they are.

‚ö†Ô∏è CRITICAL RULES - MUST FOLLOW:
1. Keep responses to 2-3 SHORT sentences (under 60 words total)
2. End with EXACTLY ONE simple question
3. NEVER ask multiple questions or use multiple question marks
4. Be conversational and curious about their actual life
5. When they mention companies/organizations: Share what you know if familiar, then ask for their perspective

PROFILE BASICS TO LEARN (prioritize early):
- Name (use it once learned!)
- Age/Birthday
- Location (current city, hometown, where they grew up)
- Work/Career/Studies
- Education background
- Family (siblings, parents, closeness)
- Relationship history
- Hobbies and interests
- What they're looking for in dating

CONVERSATION STRATEGY:
First few exchanges - Get the basics naturally:
- "Hey! I'm Cupido. What's your name?"
- "Nice to meet you [name]! Where are you based?"
- "[City] - nice! Is that where you're originally from?"

REMEMBER:
- You're building a dating profile AND facilitating discovery
- Get the basics early - don't wait too long
- Every fact has a story - explore both
- Use their name once you know it
- Keep responses SHORT but warm`;
        
        function addDebugLog(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `debug-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugPanel.appendChild(line);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        function addMessage(text, isBot = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isBot ? 'bot' : 'user'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = text;
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            addDebugLog(`${isBot ? 'Bot' : 'User'}: ${text.substring(0, 50)}...`, 'info');
        }
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || isSending) return;
            
            isSending = true;
            sendButton.disabled = true;
            
            // Add user message
            addMessage(text, false);
            messages.push({ role: 'user', content: text });
            
            messageInput.value = '';
            typingIndicator.style.display = 'block';
            
            addDebugLog('Sending to API...', 'info');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: messages,
                        modelType: 'sonnet',
                        systemPrompt: CRITICAL_RULES_PROMPT
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                addDebugLog(`Response received (${data.cacheStats?.outputTokens || 0} tokens)`, 'success');
                
                // Add bot response
                addMessage(data.message, true);
                messages.push({ role: 'assistant', content: data.message });
                
                statusEl.textContent = `Connected ‚Ä¢ Using ${data.usedModel || 'sonnet'}`;
                
            } catch (error) {
                addDebugLog(`Error: ${error.message}`, 'error');
                statusEl.textContent = 'Error connecting to server';
                addMessage('Sorry, I had trouble processing that. Please try again.', true);
            } finally {
                isSending = false;
                sendButton.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Initial greeting
        setTimeout(() => {
            addMessage("Hey! I'm Cupido. What's your name?", true);
            messages.push({ role: 'assistant', content: "Hey! I'm Cupido. What's your name?" });
            statusEl.textContent = 'Connected ‚Ä¢ Critical Rules Active';
            addDebugLog('Initial greeting sent', 'success');
        }, 500);
        
        // Test server connection
        fetch('http://localhost:3001/api/prompts')
            .then(r => r.json())
            .then(data => {
                addDebugLog(`Server connected, ${data.length || 0} prompts available`, 'success');
            })
            .catch(err => {
                addDebugLog('Warning: Could not verify prompt availability', 'error');
            });
    </script>
</body>
</html>