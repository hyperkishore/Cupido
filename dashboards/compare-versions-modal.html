<!-- Compare Versions Modal -->
<div id="compare-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeCompareModal()"></div>
    <div class="modal-content compare-modal-content">
        <div class="modal-header">
            <h2>Compare Versions</h2>
            <button class="modal-close" onclick="closeCompareModal()">Ã—</button>
        </div>

        <!-- Version Selectors -->
        <div class="compare-selectors">
            <div class="compare-selector-group">
                <label>From Version:</label>
                <select id="compare-from-version" onchange="updateComparison()">
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div class="compare-selector-group">
                <label>To Version:</label>
                <select id="compare-to-version" onchange="updateComparison()">
                    <!-- Populated dynamically -->
                </select>
            </div>
        </div>

        <!-- Side-by-side comparison -->
        <div class="compare-container">
            <div class="compare-panel">
                <div class="compare-panel-header" id="compare-from-header">Version 1.0.0</div>
                <div class="compare-panel-content" id="compare-from-content"></div>
            </div>
            <div class="compare-panel">
                <div class="compare-panel-header" id="compare-to-header">Version 2.0.0</div>
                <div class="compare-panel-content" id="compare-to-content"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    z-index: 10001;
}

.compare-modal-content {
    width: 1400px;
    height: 85vh;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #d2d2d7;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 32px;
    color: #86868b;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.modal-close:hover {
    background-color: #f5f5f7;
}

/* Compare selectors */
.compare-selectors {
    padding: 20px 24px;
    border-bottom: 1px solid #d2d2d7;
    display: flex;
    gap: 20px;
}

.compare-selector-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.compare-selector-group label {
    font-size: 13px;
    font-weight: 500;
    color: #1d1d1f;
}

.compare-selector-group select {
    padding: 8px 12px;
    border: 1px solid #d2d2d7;
    border-radius: 6px;
    font-size: 14px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: white;
    cursor: pointer;
}

/* Compare container */
.compare-container {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: #d2d2d7;
    overflow: hidden;
}

.compare-panel {
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.compare-panel-header {
    padding: 12px 16px;
    background: #f5f5f7;
    border-bottom: 1px solid #d2d2d7;
    font-size: 13px;
    font-weight: 600;
    color: #1d1d1f;
}

.compare-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Diff highlighting */
.diff-line {
    display: block;
    margin: 0;
    padding: 2px 0;
}

.diff-added {
    background-color: #d1f4d1;
    color: #0d6932;
}

.diff-removed {
    background-color: #ffd8d8;
    color: #d60000;
    text-decoration: line-through;
}

.diff-unchanged {
    color: #1d1d1f;
}

.diff-changed {
    background-color: #fff4cc;
    color: #8b6914;
}
</style>

<script>
// Compare versions state
let compareState = {
    fromVersion: null,
    toVersion: null,
    versions: []
};

// Open compare modal
function openCompareModal() {
    const prompt = promptLibraryState.selectedPrompt;
    if (!prompt || !promptLibraryState.selectedVersionHistory) {
        alert('Please select a prompt first');
        return;
    }

    const versions = promptLibraryState.selectedVersionHistory;
    if (versions.length < 2) {
        alert('This prompt only has one version. Cannot compare.');
        return;
    }

    compareState.versions = versions;

    // Populate version selectors
    const fromSelect = document.getElementById('compare-from-version');
    const toSelect = document.getElementById('compare-to-version');

    fromSelect.innerHTML = versions.map((v, i) =>
        `<option value="${i}">${v.version_string}${v.is_active ? ' (active)' : ''}</option>`
    ).join('');

    toSelect.innerHTML = versions.map((v, i) =>
        `<option value="${i}">${v.version_string}${v.is_active ? ' (active)' : ''}</option>`
    ).join('');

    // Default: compare current vs previous (or latest vs previous)
    const currentIndex = promptLibraryState.currentVersionIndex || 0;
    const previousIndex = Math.min(currentIndex + 1, versions.length - 1);

    fromSelect.value = previousIndex;
    toSelect.value = currentIndex;

    compareState.fromVersion = versions[previousIndex];
    compareState.toVersion = versions[currentIndex];

    // Show modal
    document.getElementById('compare-modal').style.display = 'flex';

    // Update comparison
    updateComparison();
}

// Close compare modal
function closeCompareModal() {
    document.getElementById('compare-modal').style.display = 'none';
}

// Update comparison when selectors change
function updateComparison() {
    const fromIndex = parseInt(document.getElementById('compare-from-version').value);
    const toIndex = parseInt(document.getElementById('compare-to-version').value);

    compareState.fromVersion = compareState.versions[fromIndex];
    compareState.toVersion = compareState.versions[toIndex];

    renderComparison();
}

// Render the comparison with diff highlighting
function renderComparison() {
    const from = compareState.fromVersion;
    const to = compareState.toVersion;

    // Update headers
    document.getElementById('compare-from-header').textContent =
        `v${from.version_string}${from.is_active ? ' (active)' : ''}`;
    document.getElementById('compare-to-header').textContent =
        `v${to.version_string}${to.is_active ? ' (active)' : ''}`;

    // Simple line-by-line diff
    const fromLines = (from.system_prompt || '').split('\n');
    const toLines = (to.system_prompt || '').split('\n');

    const fromHtml = generateDiffHtml(fromLines, toLines, 'from');
    const toHtml = generateDiffHtml(fromLines, toLines, 'to');

    document.getElementById('compare-from-content').innerHTML = fromHtml;
    document.getElementById('compare-to-content').innerHTML = toHtml;
}

// Generate diff HTML (simple line-based diff)
function generateDiffHtml(fromLines, toLines, side) {
    const lines = side === 'from' ? fromLines : toLines;
    const otherLines = side === 'from' ? toLines : fromLines;

    let html = '';

    lines.forEach((line, i) => {
        let className = 'diff-unchanged';

        if (i >= otherLines.length) {
            // Line was added/removed
            className = side === 'from' ? 'diff-removed' : 'diff-added';
        } else if (line !== otherLines[i]) {
            // Line was changed
            if (side === 'from' && !toLines.includes(line)) {
                className = 'diff-removed';
            } else if (side === 'to' && !fromLines.includes(line)) {
                className = 'diff-added';
            } else {
                className = 'diff-changed';
            }
        }

        html += `<span class="diff-line ${className}">${escapeHtml(line)}\n</span>`;
    });

    return html;
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
