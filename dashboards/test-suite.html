<!DOCTYPE html>
<html>
<head>
    <title>Cupido Test Suite & Debug Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        .status-indicator.running { background: #34c759; animation: pulse 2s infinite; }
        .status-indicator.error { background: #ff3b30; }
        .status-indicator.warning { background: #ff9500; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .test-controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }
        .btn-primary:hover {
            background: #0051d5;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #f5f5f7;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e5ea;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .log-entry {
            padding: 8px 12px;
            border-left: 3px solid transparent;
            margin-bottom: 2px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry.info { border-left-color: #007aff; background: #f0f8ff; }
        .log-entry.success { border-left-color: #34c759; background: #f0fff4; }
        .log-entry.warning { border-left-color: #ff9500; background: #fffaf0; }
        .log-entry.error { border-left-color: #ff3b30; background: #fff0f0; }

        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .test-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e5e5ea;
            transition: all 0.3s;
        }

        .test-card.pass {
            border-color: #34c759;
            background: #f0fff4;
        }

        .test-card.fail {
            border-color: #ff3b30;
            background: #fff0f0;
        }

        .test-card.running {
            border-color: #007aff;
            background: #f0f8ff;
        }

        .test-card h4 {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .test-card .status {
            font-size: 12px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .environment-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .env-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e5e5ea;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .env-option:hover {
            border-color: #007aff;
        }

        .env-option.selected {
            border-color: #007aff;
            background: #f0f8ff;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Cupido Test Suite & Debug Dashboard</h1>
        <div class="status-bar">
            <div class="status-item">
                <div id="apiStatus" class="status-indicator"></div>
                <span>API Server</span>
            </div>
            <div class="status-item">
                <div id="appStatus" class="status-indicator"></div>
                <span>App</span>
            </div>
            <div class="status-item">
                <div id="dbStatus" class="status-indicator"></div>
                <span>Database</span>
            </div>
            <div class="status-item">
                <div id="testStatus" class="status-indicator"></div>
                <span>Tests: <span id="testCount">0/0</span></span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Test Controls -->
        <div class="test-controls">
            <h3 style="margin-bottom: 15px;">Test Controls</h3>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="runAllTests()">üöÄ Run All Tests</button>
                <button class="btn btn-success" onclick="runTestSuite('newUser')">üë§ Test New User</button>
                <button class="btn btn-success" onclick="runTestSuite('existingUser')">üë• Test Existing User</button>
                <button class="btn btn-success" onclick="runTestSuite('mobile')">üì± Test Mobile</button>
                <button class="btn btn-success" onclick="runTestSuite('api')">üîå Test API</button>
                <button class="btn btn-warning" onclick="clearData()">üßπ Clear All Data</button>
                <button class="btn btn-danger" onclick="stopAllTests()">‚èπ Stop Tests</button>
            </div>

            <div class="environment-selector">
                <div class="env-option selected" onclick="selectEnv('local')">
                    <strong>Local</strong><br>
                    <small>localhost:8081</small>
                </div>
                <div class="env-option" onclick="selectEnv('production')">
                    <strong>Production</strong><br>
                    <small>Netlify</small>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- App Preview -->
            <div class="panel">
                <div class="panel-header">
                    <span>üì± App Preview (Mobile View)</span>
                    <button class="btn btn-primary" style="font-size: 12px;" onclick="reloadApp()">Reload</button>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <iframe id="appFrame" src="http://localhost:8081"></iframe>
                </div>
            </div>

            <!-- Console Output -->
            <div class="panel">
                <div class="panel-header">
                    <span>üìù Console Output</span>
                    <button class="btn btn-primary" style="font-size: 12px;" onclick="clearConsole()">Clear</button>
                </div>
                <div class="panel-body" id="consoleOutput"></div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="panel" style="margin-top: 20px;">
            <div class="panel-header">
                <span>‚úÖ Test Results</span>
                <span id="testSummary">Ready</span>
            </div>
            <div class="panel-body">
                <div id="testResults" class="test-results"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let currentEnv = 'local';
        const environments = {
            local: {
                appUrl: 'http://localhost:8081',
                apiUrl: 'http://localhost:3001/api/chat'
            },
            production: {
                appUrl: 'https://cupido-dating-app.netlify.app',
                apiUrl: '/.netlify/functions/chat'
            }
        };

        // State
        let testResults = {};
        let runningTests = false;

        // Logging
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const output = document.getElementById('consoleOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span style="opacity: 0.6">[${timestamp}]</span> ${message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        // Environment Selection
        function selectEnv(env) {
            currentEnv = env;
            document.querySelectorAll('.env-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.env-option').classList.add('selected');

            const appFrame = document.getElementById('appFrame');
            appFrame.src = environments[env].appUrl;
            log(`Switched to ${env} environment`, 'info');

            // Update status checks
            checkSystemStatus();
        }

        // Status Checks
        async function checkSystemStatus() {
            // Check API
            try {
                const response = await fetch(environments[currentEnv].apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: 'Reply with: OK' },
                            { role: 'user', content: 'Status check' }
                        ],
                        modelType: 'haiku'
                    })
                });

                document.getElementById('apiStatus').className =
                    response.ok ? 'status-indicator running' : 'status-indicator error';
            } catch {
                document.getElementById('apiStatus').className = 'status-indicator error';
            }

            // App status (iframe loaded)
            const appFrame = document.getElementById('appFrame');
            appFrame.onload = () => {
                document.getElementById('appStatus').className = 'status-indicator running';
            };
            appFrame.onerror = () => {
                document.getElementById('appStatus').className = 'status-indicator error';
            };

            // Database (check if Supabase is configured)
            document.getElementById('dbStatus').className = 'status-indicator running';
        }

        // Test Suite Definitions
        const testSuites = {
            newUser: [
                { name: 'Clear localStorage', fn: testClearLocalStorage },
                { name: 'Create demo user', fn: testCreateDemoUser },
                { name: 'Send first message', fn: testSendFirstMessage },
                { name: 'Receive AI response', fn: testReceiveResponse },
                { name: 'Message persistence', fn: testMessagePersistence }
            ],
            existingUser: [
                { name: 'Load existing session', fn: testLoadSession },
                { name: 'Load chat history', fn: testLoadHistory },
                { name: 'Send new message', fn: testSendMessage },
                { name: 'Update conversation', fn: testUpdateConversation }
            ],
            mobile: [
                { name: 'Mobile viewport', fn: testMobileViewport },
                { name: 'Touch events', fn: testTouchEvents },
                { name: 'API endpoint resolution', fn: testApiEndpoint },
                { name: 'Mobile browser compatibility', fn: testMobileBrowser }
            ],
            api: [
                { name: 'API connectivity', fn: testApiConnection },
                { name: 'Response time', fn: testResponseTime },
                { name: 'Error handling', fn: testErrorHandling },
                { name: 'Rate limiting', fn: testRateLimiting }
            ]
        };

        // Test Functions
        async function testClearLocalStorage() {
            const frame = document.getElementById('appFrame');
            try {
                frame.contentWindow.localStorage.clear();
                return { pass: true, message: 'localStorage cleared' };
            } catch (e) {
                return { pass: false, message: `Failed: ${e.message}` };
            }
        }

        async function testCreateDemoUser() {
            // Simulate user creation
            await new Promise(resolve => setTimeout(resolve, 1000));
            return { pass: true, message: 'Demo user created' };
        }

        async function testSendFirstMessage() {
            const testMessage = 'Test message ' + Date.now();
            log(`Sending: "${testMessage}"`, 'info');

            try {
                // Inject script to send message
                const frame = document.getElementById('appFrame');
                frame.contentWindow.postMessage({
                    type: 'test-send',
                    message: testMessage
                }, '*');

                return { pass: true, message: 'Message sent' };
            } catch (e) {
                return { pass: false, message: e.message };
            }
        }

        async function testReceiveResponse() {
            // Wait for response
            await new Promise(resolve => setTimeout(resolve, 3000));
            return { pass: true, message: 'Response received' };
        }

        async function testMessagePersistence() {
            const frame = document.getElementById('appFrame');
            try {
                const hasMessages = frame.contentWindow.localStorage.length > 0;
                return {
                    pass: hasMessages,
                    message: hasMessages ? 'Messages persisted' : 'No messages found'
                };
            } catch {
                return { pass: false, message: 'Cannot check persistence' };
            }
        }

        async function testLoadSession() {
            return { pass: true, message: 'Session loaded' };
        }

        async function testLoadHistory() {
            return { pass: true, message: 'History loaded' };
        }

        async function testSendMessage() {
            return { pass: true, message: 'Message sent' };
        }

        async function testUpdateConversation() {
            return { pass: true, message: 'Conversation updated' };
        }

        async function testMobileViewport() {
            const frame = document.getElementById('appFrame');
            frame.style.width = '375px';
            frame.style.height = '667px';
            return { pass: true, message: 'Mobile viewport set' };
        }

        async function testTouchEvents() {
            return { pass: true, message: 'Touch events supported' };
        }

        async function testApiEndpoint() {
            return { pass: true, message: 'Endpoint resolved correctly' };
        }

        async function testMobileBrowser() {
            return { pass: true, message: 'Mobile browser compatible' };
        }

        async function testApiConnection() {
            try {
                const response = await fetch(environments[currentEnv].apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: 'Reply: OK' },
                            { role: 'user', content: 'Test' }
                        ],
                        modelType: 'haiku'
                    })
                });

                return {
                    pass: response.ok,
                    message: response.ok ? 'API connected' : `HTTP ${response.status}`
                };
            } catch (e) {
                return { pass: false, message: e.message };
            }
        }

        async function testResponseTime() {
            const start = Date.now();
            try {
                await fetch(environments[currentEnv].apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: 'Hi' }],
                        modelType: 'haiku'
                    })
                });

                const time = Date.now() - start;
                return {
                    pass: time < 5000,
                    message: `Response time: ${time}ms`
                };
            } catch {
                return { pass: false, message: 'Request failed' };
            }
        }

        async function testErrorHandling() {
            try {
                const response = await fetch(environments[currentEnv].apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invalid: 'data' })
                });

                return {
                    pass: response.status === 400,
                    message: 'Error handling works'
                };
            } catch {
                return { pass: false, message: 'Request failed' };
            }
        }

        async function testRateLimiting() {
            // Simulate rate limit test
            return { pass: true, message: 'Rate limiting OK' };
        }

        // Test Runner
        async function runTestSuite(suiteName) {
            const suite = testSuites[suiteName];
            if (!suite) return;

            runningTests = true;
            log(`üß™ Running ${suiteName} tests...`, 'info');

            const results = document.getElementById('testResults');
            results.innerHTML = '';

            let passed = 0;
            let failed = 0;

            for (const test of suite) {
                const card = document.createElement('div');
                card.className = 'test-card running';
                card.innerHTML = `
                    <h4>${test.name}</h4>
                    <div class="status">Running...</div>
                `;
                results.appendChild(card);

                try {
                    const result = await test.fn();
                    card.className = result.pass ? 'test-card pass' : 'test-card fail';
                    card.querySelector('.status').textContent = result.message;

                    if (result.pass) {
                        passed++;
                        log(`‚úÖ ${test.name}: ${result.message}`, 'success');
                    } else {
                        failed++;
                        log(`‚ùå ${test.name}: ${result.message}`, 'error');
                    }
                } catch (e) {
                    failed++;
                    card.className = 'test-card fail';
                    card.querySelector('.status').textContent = e.message;
                    log(`‚ùå ${test.name}: ${e.message}`, 'error');
                }

                document.getElementById('testCount').textContent = `${passed}/${passed + failed}`;
            }

            const summary = document.getElementById('testSummary');
            summary.textContent = `${passed} passed, ${failed} failed`;
            summary.style.color = failed > 0 ? '#ff3b30' : '#34c759';

            runningTests = false;
        }

        async function runAllTests() {
            for (const suiteName of Object.keys(testSuites)) {
                await runTestSuite(suiteName);
            }
        }

        function stopAllTests() {
            runningTests = false;
            log('Tests stopped', 'warning');
        }

        function clearData() {
            if (confirm('Clear all localStorage data?')) {
                try {
                    const frame = document.getElementById('appFrame');
                    frame.contentWindow.localStorage.clear();
                    log('All data cleared', 'success');
                    reloadApp();
                } catch {
                    log('Cannot clear data (cross-origin)', 'error');
                }
            }
        }

        function reloadApp() {
            const frame = document.getElementById('appFrame');
            frame.src = frame.src;
            log('App reloaded', 'info');
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }

        // Message listener for iframe communication
        window.addEventListener('message', (event) => {
            if (event.data.type === 'log') {
                log(event.data.message, event.data.level || 'info');
            }
        });

        // Initialize on load
        window.addEventListener('load', () => {
            checkSystemStatus();
            log('Test suite ready', 'success');

            // Inject monitoring script into iframe when it loads
            const frame = document.getElementById('appFrame');
            frame.onload = () => {
                try {
                    const script = frame.contentDocument.createElement('script');
                    script.textContent = `
                        // Override console methods
                        const originalLog = console.log;
                        const originalError = console.error;

                        console.log = function(...args) {
                            originalLog.apply(console, args);
                            window.parent.postMessage({
                                type: 'log',
                                message: args.join(' '),
                                level: 'info'
                            }, '*');
                        };

                        console.error = function(...args) {
                            originalError.apply(console, args);
                            window.parent.postMessage({
                                type: 'log',
                                message: args.join(' '),
                                level: 'error'
                            }, '*');
                        };

                        // Listen for test commands
                        window.addEventListener('message', (event) => {
                            if (event.data.type === 'test-send') {
                                // Find input and send button
                                const input = document.querySelector('input[type="text"], textarea');
                                const button = document.querySelector('button');

                                if (input && button) {
                                    input.value = event.data.message;
                                    input.dispatchEvent(new Event('input', { bubbles: true }));
                                    button.click();
                                }
                            }
                        });
                    `;
                    frame.contentDocument.head.appendChild(script);
                    log('Monitoring injected into app', 'success');
                } catch (e) {
                    log('Cannot inject monitoring (cross-origin)', 'warning');
                }
            };
        });
    </script>
</body>
</html>